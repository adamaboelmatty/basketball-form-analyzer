// Copy these Firestore Security Rules to Firebase Console
// Location: https://console.firebase.google.com/u/0/project/arc-ai-481122/firestore/rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ====================================
    // DEVELOPMENT RULES (Permissive)
    // TODO: Tighten for production
    // ====================================
    
    // Users collection - anyone authenticated can read/write
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // Sessions collection - authenticated users can read/write
    match /sessions/{sessionId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // Analyses collection - authenticated users can read/write
    match /analyses/{analysisId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // Organizations (for ARC Coach web app)
    match /organizations/{orgId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // Teams (for ARC Coach web app)
    match /teams/{teamId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // Team memberships (for ARC Coach web app)
    match /memberships/{membershipId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // Players roster (for ARC Coach web app)
    match /players/{playerId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // Coach assignments (for ARC Coach web app)
    match /coachAssignments/{assignmentId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // Coach notes (for ARC Coach web app)
    match /coachNotes/{noteId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
  }
}


// ====================================
// PRODUCTION RULES (Use Later)
// ====================================
// Uncomment and customize when ready for production

/*
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function hasTeamMembership(teamId) {
      return exists(/databases/$(database)/documents/memberships/$(teamId + '_' + request.auth.uid));
    }
    
    function isTeamCoach(teamId) {
      let membership = get(/databases/$(database)/documents/memberships/$(teamId + '_' + request.auth.uid));
      return membership.data.role == 'coach';
    }
    
    function canEditTeam(teamId) {
      let membership = get(/databases/$(database)/documents/memberships/$(teamId + '_' + request.auth.uid));
      return membership.data.role in ['coach', 'assistant'];
    }
    
    // Users - can only read/write own data
    match /users/{userId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if isAuthenticated() && isOwner(userId);
    }
    
    // Sessions - user owns OR team member can read
    match /sessions/{sessionId} {
      allow read: if isAuthenticated() && (
        isOwner(resource.data.userId) || 
        hasTeamMembership(resource.data.teamId)
      );
      allow write: if isAuthenticated() && isOwner(request.auth.uid);
    }
    
    // Analyses - user owns only
    match /analyses/{analysisId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow write: if isAuthenticated() && isOwner(request.auth.uid);
    }
    
    // Organizations - owner can manage
    match /organizations/{orgId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isOwner(resource.data.ownerUid);
    }
    
    // Teams - members can read, coaches can write
    match /teams/{teamId} {
      allow read: if isAuthenticated() && hasTeamMembership(teamId);
      allow write: if isAuthenticated() && isTeamCoach(teamId);
    }
    
    // Memberships - team coaches can manage
    match /memberships/{membershipId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isTeamCoach(resource.data.teamId);
    }
    
    // Players - team coaches/assistants can manage
    match /players/{playerId} {
      allow read: if isAuthenticated() && hasTeamMembership(resource.data.teamId);
      allow write: if isAuthenticated() && canEditTeam(resource.data.teamId);
    }
    
    // Coach assignments - coaches/assistants can manage
    match /coachAssignments/{assignmentId} {
      allow read: if isAuthenticated() && hasTeamMembership(resource.data.teamId);
      allow write: if isAuthenticated() && canEditTeam(resource.data.teamId);
    }
    
    // Coach notes - coaches/assistants can manage
    match /coachNotes/{noteId} {
      allow read: if isAuthenticated() && hasTeamMembership(resource.data.teamId);
      allow write: if isAuthenticated() && canEditTeam(resource.data.teamId);
    }
  }
}
*/
